## 3.2 Проведение урока

Проведение онлайн-урока на платформе реализовано как интеграция клиентской части (frontend) и видео-сервиса (video-service), обеспечивающей бронирование, запуск и проведение видеосессии между учеником и преподавателем. Процесс включает несколько этапов: бронирование урока, подготовка комнаты, подключение участников и завершение урока.

### Этапы проведения урока

1. **Бронирование урока**  
   Ученик выбирает преподавателя, язык, дату и время, после чего отправляет запрос на бронирование. Сервер сохраняет урок в базе данных.

2. **Подготовка к уроку**  
   Перед началом урока оба участника видят список своих уроков. За 5 минут до старта появляется возможность войти в виртуальную комнату.

3. **Создание и подключение к видео-комнате**  
   При входе в комнату frontend проверяет существование комнаты в видео-сервисе (по ID урока). Если комнаты нет — она создаётся. Далее оба участника подключаются к WebRTC-видеосвязи и чату.

4. **Проведение урока**  
   Видеосвязь и чат осуществляются через WebRTC и WebSocket-соединения с видео-сервисом. Весь трафик идёт напрямую между браузерами, сервер выступает как сигналинг и ретранслятор.

5. **Завершение урока**  
   По окончании времени урока или по инициативе участников комната закрывается, статус урока обновляется, появляется возможность оставить отзыв.

---

### Dataflow-диаграмма процесса создания и проведения урока

```plantuml
@startuml
!theme plain
actor Ученик
actor Преподаватель
participant "Клиент (Frontend)" as FE
participant "Сервер (API)" as BE
participant "Видео-сервис" as VS
database "База данных"

== Бронирование урока ==
Ученик -> FE : Выбор преподавателя, языка, времени
FE -> BE : POST /api/lessons \n{tutor_id, language_id, start_time, end_time, ...}
BE -> "База данных" : INSERT INTO lessons ...
"База данных" --> BE : id урока, детали
BE --> FE : Ответ с деталями урока

== Подготовка к уроку ==
FE -> BE : GET /api/lessons/user/scheduled
BE -> "База данных" : SELECT ... FROM lessons WHERE user_id=...
"База данных" --> BE : Список уроков
BE --> FE : Список уроков

== Вход в комнату (за 5 минут до начала) ==
Ученик -> FE : Клик "Войти в урок"
FE -> VS : GET /api/room/{lesson_id}/exists
VS --> FE : {exists: false/true}
alt Комната не существует
    FE -> VS : POST /api/room/create/{lesson_id}
    VS --> FE : {success: true, room_id}
end

== Подключение к видео и чату ==
FE -> VS : GET /api/room/{lesson_id}/video
VS --> FE : WebSocket URL для видео
FE -> VS : GET /api/room/{lesson_id}/chat
VS --> FE : WebSocket URL для чата

== Видеосвязь и чат ==
Ученик -> FE : Взаимодействие (видео, чат)
FE -> VS : WebSocket соединение (видео, чат)
Преподаватель -> FE : Вход в комнату
FE -> VS : WebSocket соединение (видео, чат)
note right of VS
  Видео-сервис ретранслирует
  WebRTC и чат между участниками
end note

== Завершение урока ==
FE -> BE : PATCH /api/lessons/{id}/complete
BE -> "База данных" : UPDATE lessons SET status='completed'
"База данных" --> BE : OK
BE --> FE : Ответ об окончании урока
FE -> Ученик : Отображение формы отзыва

@enduml
```

---

### Описание диаграммы

- **Ученик** инициирует бронирование через клиентское приложение, данные отправляются на сервер, где создаётся запись урока.
- **Клиент** периодически запрашивает список уроков для отображения расписания.
- За 5 минут до начала урока появляется кнопка "Войти". При нажатии клиент проверяет наличие комнаты в видео-сервисе, при необходимости создаёт её.
- Для подключения к видео и чату клиент получает WebSocket-адреса и устанавливает соединения.
- Видеосвязь и чат реализованы через WebRTC и WebSocket, сервер видео-сервиса управляет комнатами и ретрансляцией.
- После завершения урока статус обновляется, появляется возможность оставить отзыв.

---

### Ключевые особенности реализации

- **Масштабируемость**: Комнаты создаются динамически, идентификатором служит ID урока.
- **Безопасность**: Доступ к комнате возможен только для участников урока.
- **Гибкость**: Видеосервис и API разделены, что позволяет масштабировать их независимо. 