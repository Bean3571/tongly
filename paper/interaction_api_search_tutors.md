## Процесс поиска репетиторов с фильтрами

Поиск репетиторов осуществляется через клиентский интерфейс, где пользователь (студент) выбирает необходимые фильтры (языки, уровень владения, интересы, цели, опыт, возраст, пол и др.). После выбора фильтров формируется HTTP-запрос к серверу, который обрабатывает параметры, выполняет бизнес-логику поиска и возвращает список подходящих профилей.

```plantuml
@startuml
!theme plain
actor Пользователь
participant "Клиент (FE)" as FE
participant "Сервер (API)" as BE
participant "UseCase поиска" as UC
participant "TutorRepository"
participant "UserRepository"
participant "StudentRepository"
participant "LessonRepository"
database "База данных"

Пользователь -> FE : Выбирает фильтры поиска
FE -> BE : GET /api/tutors/search?filters
BE -> UC : Вызов SearchTutors(filters)
UC -> TutorRepository : Поиск профилей
TutorRepository -> "База данных" : SELECT ... FROM tutor_profiles ... WHERE ...
"База данных" --> TutorRepository : Список профилей
TutorRepository --> UC : Сырые профили

loop Для каждого найденного профиля
    UC -> UserRepository : Получить user info
    UserRepository -> "База данных" : SELECT ... FROM users WHERE id=?
    "База данных" --> UserRepository : user info
    UserRepository --> UC : user info
    UC -> StudentRepository : Получить языки
    StudentRepository -> "База данных" : SELECT ... FROM user_languages WHERE user_id=?
    "База данных" --> StudentRepository : языки
    StudentRepository --> UC : языки
    UC -> LessonRepository : Получить рейтинг
    LessonRepository -> "База данных" : SELECT AVG(rating) ...
    "База данных" --> LessonRepository : рейтинг
    LessonRepository --> UC : рейтинг
    UC -> LessonRepository : Получить кол-во отзывов
    LessonRepository -> "База данных" : SELECT COUNT(*) ...
    "База данных" --> LessonRepository : число отзывов
    LessonRepository --> UC : число отзывов
end

UC --> BE : Список аннотированных профилей
BE --> FE : Ответ с профилями
FE -> Пользователь : Отображает результаты поиска
@enduml
```

### Пояснение к процессу

Процесс поиска репетиторов начинается с того, что пользователь на клиенте выбирает необходимые параметры поиска, такие как языки, интересы, опыт, возраст, пол и другие фильтры. После этого клиентская часть формирует GET-запрос на эндпоинт `/api/tutors/search`, передавая выбранные параметры в виде query-параметров. Серверная часть принимает этот запрос и передаёт управление в usecase поиска репетиторов, который инкапсулирует бизнес-логику. Usecase вызывает метод репозитория, отвечающего за поиск профилей по заданным фильтрам. Репозиторий формирует SQL-запрос, учитывая все переданные параметры: языки, уровень владения, интересы, цели, опыт, возраст и пол. После выполнения запроса к базе данных возвращается список подходящих профилей. Для каждого найденного профиля usecase дополнительно запрашивает информацию о пользователе, список языков, средний рейтинг и количество отзывов, чтобы обогатить профиль всей необходимой информацией. После этого итоговый список аннотированных профилей возвращается серверу, который отправляет клиенту JSON-ответ. Клиент отображает результаты поиска пользователю.

#### Формирование SQL-запроса для фильтрации

На этапе поиска репозиторий динамически формирует SQL-запрос, добавляя условия в зависимости от выбранных фильтров. Например, если пользователь указал языки, в запрос добавляется подзапрос с фильтрацией по языкам через таблицу `user_languages` и соответствующие идентификаторы языков. Аналогично, если задан минимальный опыт, добавляется условие по полю `years_experience`. Для фильтрации по уровню владения языком используется подзапрос с проверкой минимального значения `proficiency_id`. Интересы, цели, возраст и пол также добавляются в SQL-запрос как отдельные условия с помощью конструкции `AND`. Все условия объединяются в единую WHERE-часть, что позволяет гибко фильтровать репетиторов по любым комбинациям параметров. Такой подход обеспечивает высокую точность и производительность поиска, а также масштабируемость при добавлении новых фильтров.

**Примечания:**
- Все фильтры (языки, уровень, интересы, цели, опыт, возраст, пол) обрабатываются на уровне SQL-запроса.
- Для каждого профиля дополнительно подтягиваются связанные сущности (user, языки, рейтинг, отзывы).